---
title: "L2C Smartphone App Paper - Descriptive Table for the Use App question"
date: "2021-08-03 <br> Updated: `r Sys.Date()`"
---


# ⭐️Overview

In this file we create a descriptive table exploring the relationships between using a smartphone app to manage health-related uses and each of the following: sociodemographic background, lifetime homelessness, lifetime incarceration, physical and mental health, and access to a mobile phone and data plan.

Do you believe that a smartphone app can help you to change your actions or behavior?
0	=	No
1	=	Yes
7	=	Don't Know
8	=	Refuse to Answer
9	=	Not Applicable


# 📦Load packages

```{r message=FALSE}
library(dplyr, warn.conflicts = FALSE)
library(freqtables)
library(meantables)
library(purrr)
library(officer)
library(flextable, warn.conflicts = FALSE)
```

```{r}
source("flextable_helpers.R")
```


# 🌎Connect to UTH server 

```{bash eval=FALSE}
# Make sure you are connected to the VPN
open 'smb://islgpcifs.uthouston.edu/sph_research/'
```


# 📥Import data 

Import and clean data using data_01_import_clean.Rmd

```{r}
source_rmd <- function(file, ...) {
  tmp_file = tempfile(fileext=".R")
  on.exit(unlink(tmp_file), add = TRUE)
  knitr::purl(file, output=tmp_file)
  source(file = tmp_file, ...)
}
```

```{r}
source_rmd("data_01_import_clean.Rmd")
```

```{r}
dim(v1) # 303 29
```


# 🚧Data management

Drop rows with missing outcome

```{r}
v1_use_app <- v1 %>%
  filter(!is.na(use_app_f))
```


# 📈Analysis

## Outcome distribution

```{r}
n_use_app <- v1_use_app %>% 
  freq_table(use_app_f) %>% 
  pull(n) %>%
  set_names(levels(v1_use_app$use_app_f))

n_use_app
```

## Create helper functions

For calculating statistics of interest.

### Categorical statistics

```{r eval=FALSE}
# For testing
v1_use_app %>% 
  freq_table(use_app_f, gender_f) %>% 
  freq_format("percent_row (lcl_row - ucl_row)", digits = 0) %>% 
  # Change col_var to var to make it easier to bind with cont stats later
  select(row_cat, var = col_var, col_cat, formatted_stats) %>% 
  tidyr::pivot_wider(
    names_from = "row_cat",
    values_from = "formatted_stats"
  ) %>% 
  # Add blank row below
  add_row(var = "", col_cat = "", No = "", Yes = "")
```

```{r}
cat_stats_fn <- function(.data, .outcome, .pred, .digits = 0) {
  .data %>% 
    freq_table({{ .outcome }}, {{ .pred }}) %>% 
    freq_format("percent_row (lcl_row - ucl_row)", digits = .digits) %>% 
    # Change col_var to var to make it easier to bind with cont stats later
    select(row_cat, var = col_var, col_cat, formatted_stats) %>% 
    tidyr::pivot_wider(
      names_from = "row_cat",
      values_from = "formatted_stats"
    ) %>% 
    # Add blank row below
    add_row(var = "", col_cat = "", No = "", Yes = "")
}

# For testing
# cat_stats_fn(v1_use_app, use_app_f, gender_f)
# cat_stats_fn(v1_use_app, use_app_f, !!sym("gender_f"))
```

### Continuous statistics

```{r eval=FALSE}
# For testing
v1_use_app %>% 
  group_by(use_app_f) %>% 
  mean_table(age) %>% 
  freq_format("mean (lcl - ucl)", digits = 0) %>% 
  # Change response_var to var to make it easier to bind with cat stats later
  select(var = response_var, group_cat, formatted_stats) %>% 
  tidyr::pivot_wider(
    names_from = "group_cat",
    values_from = "formatted_stats"
  ) %>% 
  # Add blank row below
  add_row(var = "", No = "", Yes = "")
```

```{r}
cont_stats_fn <- function(.data, .outcome, .pred, .digits = 0) {
  .data %>% 
    group_by({{ .outcome }}) %>% 
    mean_table({{ .pred }}) %>% 
    freq_format("mean (lcl - ucl)", digits = .digits) %>% 
    # Change response_var to var to make it easier to bind with cat stats later
    select(var = response_var, group_cat, formatted_stats) %>% 
    tidyr::pivot_wider(
      names_from = "group_cat",
      values_from = "formatted_stats"
    ) %>% 
    # Add blank row below
    add_row(var = "", No = "", Yes = "")
}

# For testing
# cont_stats_fn(v1_use_app, use_app_f, age)
```

## Create table

```{r}
cat_cols <- c(
  "gender_f", "race_eth_4_cat_f", "high_school_grad_f", "employ_5_cat_f", "genhealth_f",
  "ment_health_treat_f", "have_mobile_f", "have_data_plan_f" 
)
```


```{r}
cont_cols <- c("age", "lifetime_homeless", "lifetime_jail")
```

```{r}
cat_stats_list <- cat_cols %>%
  set_names(cat_cols) %>% 
  map(~ cat_stats_fn(v1_use_app, use_app_f, !! sym(.x)))
```

**NOTE:** The question about having a data plan has a ton of missing (77%). I dug into this a little more. It's because only 84 out of the 303 participants reported having a cell phone at all. In that light, 71 of those 84 (85%) responded to the question about having a data plan. These numbers will obviously change over time as we collect more data, but I imagine the proportions will remain relatively constant.

I could have dropped the row containing the NA responses directly inside of `cat_stats_fn` above, but I like that I was able to see all the missing and investigate it. Having said that, I don't think we need that row to appear in the final table. I'm going to drop it now. We can't just filter it out though, the percentages won't be correct.

```{r}
cat_stats_list$have_data_plan_f <- v1_use_app %>% 
  filter(!is.na(have_data_plan_f)) %>% 
  cat_stats_fn(use_app_f, have_data_plan_f)
```

```{r}
cont_stats_list <- cont_cols %>% 
  set_names(cont_cols) %>% 
  map(~ cont_stats_fn(v1_use_app, use_app_f, !! sym(.x)))
```

# Bind together categorical and continuous stats

```{r}
table <- bind_rows(
  cont_stats_list$age, 
  cat_stats_list$gender_f, 
  cat_stats_list$race_eth_4_cat_f,
  cat_stats_list$high_school_grad_f,
  cat_stats_list$employ_5_cat_f,
  cat_stats_list$genhealth_f,
  cat_stats_list$ment_health_treat_f,
  cont_stats_list$lifetime_homeless,
  cont_stats_list$lifetime_jail,
  cat_stats_list$have_mobile_f,
  cat_stats_list$have_data_plan_f
)
```

```{r}
table <- table %>% 
  select(var, col_cat, No, Yes)
```


# 🔴 Automation and arranging column names

Ran out of time. Come back and do this later. Add to R Notes.

This was works, but so much repetition. Let's add it to R Notes just in case. May even want to add using `set_names()` to name the list created by `map()` to the purrr chapter.

https://stackoverflow.com/questions/43935160/use-input-of-purrrs-map-function-to-create-a-named-list-as-output-in-r

Instead, I want use map_df, bind the data frames, and then sort var as a factor.

https://stackoverflow.com/questions/26548495/reorder-rows-using-custom-order/26548692

```{r}
# cat_stats <- cat_cols %>%
#   map_df(~ cat_stats_fn(v1_use_app, use_app_f, !! sym(.x)))
```

```{r}
# cat_stats %>% 
#   muate(var = factor(var, ))
```

# Create flextable

```{r}
table_ft <- flextable(table) %>% 
  my_ft_theme() %>% 
  autofit()
```

Output Word document for easy copy paste into template (DELETE)
* Bold  total manually.

```{r}
read_docx() %>%
  body_add_flextable(table_ft) %>% 
  print("table_1_ft.docx")
```









# 🗑Clean up

```{r}
rm(list = ls())
```

```{r echo=FALSE}
sessionInfo()
```
